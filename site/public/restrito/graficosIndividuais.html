<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../resources/css/menu_dash.css">
    <link rel="stylesheet" href="../resources/css/graficoIndiv.css">
    <link rel="stylesheet" href="../resources/css/bot.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="../resources/img/LogoEyeMarketFundoBranco.jpg">
    <title>Dashboard | Gráficos</title>
</head>

<body>
    <div class="bot_help" id="bot_help">
        <div class="bot_header">

            <div class="nomeBot">
                Suporte | EyeMarket
            </div>

            <div class="bot_sair" onclick="fecharBot()">
                X
            </div>
        </div>

        <div class="mensagens">
            <div class="mensagem_bot" id="msgFirst">
                <div class="perfil_bot">
                    <img src="../resources/img/robo.png" alt="">
                </div>
                <div class="msg">
                    Olá &#128075; , no que posso ajudar?
                </div>
            </div>
            <div class="escolha" id="escolha">
                Escolha uma opção abaixo

                <div class="opcao" onclick="opcao1()">
                    Problema com o site web
                </div>

                <div class="opcao" onclick="opcao2()">
                    Problema com a aplicação no totem
                </div>
            </div>

            <div class="mensagem_bot" id="opcaoOne">
                <div class="perfil_bot">
                    <img src="../resources/img/robo.png" alt="">
                </div>
                <div class="msg">
                    &#128071; Segue abaixo um PDF com os principais problemas e soluções! Caso ainda não tenha resolvido
                    seu problema clique em <b>"Contatar Suporte"</b>
                </div>
            </div>

            <div class="escolha" id="escolha2" style="display: none;">
                Escolha uma opção abaixo

                <div class="opcao" onclick="opcao1()">
                    &#128229; Baixar PDF
                </div>

                <a href="helpdesk.html">
                    <div class="opcao">
                        &#9993; Contatar suporte
                    </div>
                </a>

                <div class="opcao" onclick="voltar()">
                    &#128281; Voltar
                </div>
            </div>


            <div class="mensagem_bot" id="opcaoTwo">
                <div class="perfil_bot">
                    <img src="../resources/img/robo.png" alt="">
                </div>
                <div class="msg">
                    &#128071; Segue abaixo um PDF com os principais problemas e soluções! Caso ainda não tenha resolvido
                    seu problema clique em <b>"Contatar Suporte"</b>
                </div>
            </div>

            <div class="escolha" id="escolha3" style="display: none;">
                Escolha uma opção abaixo

                <div class="opcao" onclick="opcao1()">
                    &#128229; Baixar PDF
                </div>

                <a href="helpdesk.html">
                    <div class="opcao">
                        &#9993; Contatar suporte
                    </div>
                </a>

                <div class="opcao" onclick="voltar()">
                    &#128281; Voltar
                </div>
            </div>
        </div>
    </div>
    <div class="menu_dash">
        <a href="index_restrita.html">
            <div class="icon" aria-label="Home"><img src="../resources/img/silhueta_casa.png" /></div>
        </a>
        <div class="mid">
            <a href="funcionarios.html">
                <div class="icon" aria-label="Funcionários"><img src="../resources/img/silhueta_user.png" /></div>
            </a>
            <a href="graficos.html">
                <div class="icon" aria-label="Gráficos"><img src="../resources/img/silhueta_grafico.png" /></div>
            </a>
            <a href="calendario.html">
                <div class="icon" aria-label="Calendário"><img src="../resources/img/silhueta_calendario.png" /></div>
            </a>
            <a href="Totens.html">
                <div class="atv_icon" aria-label="Totens"><img src="../resources/img/silhueta_totem.png" /></div>
            </a>
        </div>
        <div class="bot">
            <div class="icon" aria-label="Suporte" onclick="abrirBot()"><img
                    src="../resources/img/silhueta_apoio.png" /></div>
            <div class="icon_sair" aria-label="Sair" onclick="sair()"><img src="../resources/img/silhueta_sair.png" />
            </div>

        </div>
    </div>
    <div class="main">

        <div class="container">
            <div class="container_header">
                <div class="header_title">Totem |ID </div>
                <div class="infos">
                    <div class="left_side">
                        <div class="info">
                            <div class="title">Processador:</div>
                            <div class="subtitulo">Intel(R) Core (TM) i5-1035G1 CPU @ 1.00GHz</div>
                        </div>
                        <div class="info">
                            <div class="title">Armazenamento:</div>
                            <div class="subtitulo">238,5 GiB</div>
                        </div>
                        <div class="info">
                            <div class="title">Sistema Operacional:</div>
                            <div class="subtitulo">Ubuntu</div>
                        </div>
                    </div>
                    <div class="right_side">
                        <img src="../resources/img/relogio.png" alt="">
                        <div class="text">TEMPO ATIVIDADE</div>
                        <div class="text">2022-10-13T20:46:58Z</div>
                    </div>
                </div>
            </div>
            <div class="graficos">
                <div class="temperatura">
                    <div class="title">Temperatura do totem</div>
                    <canvas id="myChart"></canvas>
                </div>

                <div class="memoria">
                    <div id="avisoCaptura"></div>
                    <div class="title">Memória RAM</div>
                    <p id="memoria"></p>
                    <canvas id="myMemoria"></canvas>
                </div>

                <div class="processos">
                    <img src="../resources/img/mapa-do-site.png" alt="">
                    <div class="title">200 Processos ativos</div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    let proximaAtualizacao;

    window.onload = obterDadosGrafico(1);

    function obterDadosGrafico(idMaquina) {
        // alterarTitulo(idAquario)

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idMaquina);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }


    function plotarGrafico(resposta, idMaquina) {
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = ['Em uso',
            'Disponível'];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Risco',
                data: [],
                backgroundColor: [
                    'rgb(82,41,82)',
                    'rgb(54, 162, 235)'
                ],
                hoverOffset: 4
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            // labels.push(registro.momento_grafico);
            console.log("FEIJAO "+ registro.usoMemoriaDisponivel);
            console.log("FEIJAO "+ registro.usoMemoria);
            // uso.innerHTML = `Aqui to no primeiro: disponivel: ${registro.usoMemoriaDisponivel} uso: ${registro.usoMemoria}`;
            dados.datasets[0].data.push = registro.usoMemoriaDisponivel,registro.usoMemoria;
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const configTwo = {
            type: 'doughnut',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        const myMemoria = new Chart(
        document.getElementById('myMemoria'),
        configTwo
    );

        setTimeout(() => atualizarGrafico(idMaquina, dados, myMemoria), 2000);
    }

    function atualizarGrafico(idMaquina, dados, myMemoria) {

fetch(`/medidas/tempo-real/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (novoRegistro) {

            console.log(`Dados recebidos ATUALIZADOS: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico:`);
            console.log(dados);

            document.getElementById("avisoCaptura").innerHTML = ""

            if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                console.log("---------------------------------------------------------------")
                console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                document.getElementById("avisoCaptura").innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                console.log("Horário do novo dado capturado:")
                console.log(novoRegistro[0].momento_grafico)
                console.log("Horário do último dado capturado:")
                console.log(dados.labels[dados.labels.length - 1])
                console.log("---------------------------------------------------------------")
            } else {
                // dados.labels.shift(); 
                // dados.labels.push(novoRegistro[0].momento_grafico); 

                dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                console.log("CALMA "+ novoRegistro[0].usoMemoria,novoRegistro[0].usoMemoriaDisponivel);
            // uso.innerHTML = `Aqui to no segundo: disponivel: ${novoRegistro[0].usoMemoriaDisponivel} uso: ${novoRegistro[0].usoMemoria}`;

            
                dados.datasets[0].data = [novoRegistro[0].usoMemoriaDisponivel,novoRegistro[0].usoMemoria];

                myMemoria.update();
            }

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados, myMemoria), 2000);
        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados, myPizza), 2000);
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

}
</script>


<script>
    // const labels = [
    //     '09h',
    //     '11h',
    //     '13h',
    //     '15h',
    //     '17h',
    //     '19h',
    //     '21h',
    //     '23h',
    // ];

    // const data = {
    //     labels: labels,
    //     datasets: [{
    //         label: 'Temperatura totem 1',
    //         backgroundColor: 'rgb(82,41,82)',
    //         borderColor: 'rgb(87,48,87)',
    //         data: [19, 21, 20, 22, 25, 28, 35, 25],
    //     }]
    // };

    // const config = {
    //     type: 'line',
    //     data: data,
    //     options: {}
    // };


    // const dataTwo = {
    //     labels: [
    //         'Em uso',
    //         'Disponível'
    //     ],
    //     datasets: [{
    //         label: 'My First Dataset',
    //         data: [6.8, 2.2],
    //         backgroundColor: [
    //             'rgb(82,41,82)',
    //             'rgb(54, 162, 235)'
    //         ],
    //         hoverOffset: 4
    //     }]
    // };


    // const configTwo = {
    //     type: 'doughnut',
    //     data: dataTwo,
    // };

</script>

<script>
    // const myChart = new Chart(
    //     document.getElementById('myChart'),
    //     config
    // );

    // const myMemoria = new Chart(
    //     document.getElementById('myMemoria'),
    //     configTwo
    // );
</script>

<script src="../resources/js/bot.js"></script>

<script>
    function sair() {
        sessionStorage.clear();
        window.location.replace('../index.html');
    }
</script>